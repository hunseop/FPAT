# SSH Checker 개선사항 요약

## 개선된 기능들

### 1. 터미널 초기 설정 (`_setup_terminal`)
- **추가 명령어**: 연결 시 자동으로 다음 명령어들을 실행
  - `set cli pager off`: 페이지 출력 제거로 --More-- 프롬프트 방지
  - `set cli scripting-mode on`: 스크립트 모드 설정으로 일관된 출력 보장
- **설정 적용 확인**: 각 설정 명령어 실행 후 출력 수신 및 오류 처리
- **연결 오류 처리**: 설정 중 연결 문제 발생 시 적절한 오류 메시지 반환

### 2. ANSI 이스케이프 코드 및 제어문자 정리 (`_remove_ansi_codes`, `_remove_control_characters`)
- **ANSI 코드 제거**: 다양한 ANSI 이스케이프 시퀀스 패턴 처리
  - `\x1b[...m` (색상 코드)
  - `\x1b[...K` (라인 지우기)
  - `\x1b]...` (OSC 시퀀스)
  - 기타 터미널 제어 시퀀스
- **제어문자 정리**: 출력을 방해하는 제어문자들 제거
  - `\r` (캐리지 리턴)
  - `\b` (백스페이스)
  - `\x07` (벨)
  - `\x0f`, `\x0e` (Shift In/Out)

### 3. 향상된 프롬프트 감지 (`_is_prompt_line`, `_check_prompt_in_output`)
- **다양한 프롬프트 패턴 지원**:
  - `호스트명@장비명>` 형태
  - `(컨텍스트)>` 형태
  - 기존 `>`, `#`, `$` 패턴들
- **ANSI 코드 제거 후 패턴 매칭**: 색상 코드 등에 의한 오인식 방지
- **마지막 3줄 확인**: 프롬프트 감지 정확도 향상

### 4. 출력 필터링 개선 (`_clean_command_output`)
- **포괄적 출력 정리 단계**:
  1. ANSI 이스케이프 코드 제거
  2. 제어문자 정리
  3. 명령어 에코 제거
  4. 프롬프트 라인 제거
  5. --More-- 패턴 제거
  6. 빈 줄 정리
- **첫 유효 출력부터 파싱**: 명령어 에코와 프롬프트를 제외한 실제 결과만 반환

### 5. --More-- 페이지 출력 처리 (`_handle_more_prompt`)
- **다양한 More 패턴 감지**:
  - `--More--`, `-- More --`
  - `(more)`, `--more--`
  - 대소문자 구분 없음
- **자동 진행**: 스페이스바 전송으로 페이지 출력 자동 진행
- **오류 처리**: 전송 실패 시 예외 무시하고 계속 진행

### 6. 명령어 옵션 향상 (`_enhance_command`)
- **색상 출력 제거**: Linux 명령어에 `--color=never` 옵션 자동 추가
- **기존 파이프 보존**: 이미 파이프가 있는 명령어는 수정하지 않음
- **Palo Alto 최적화**: 터미널 설정으로 인해 추가 옵션 불필요

### 7. 오류 처리 강화
- **연결 상태 확인**: 
  - 셸 닫힘 상태 감지
  - Transport 활성화 상태 확인
  - 연결 건강성 체크 (`_check_connection_health`)
- **세분화된 예외 처리**:
  - `paramiko.SSHException`: SSH 연결 오류
  - `socket.error`: 네트워크 오류
  - `OSError`: 시스템 레벨 오류
  - `UnicodeDecodeError`: 인코딩 오류
- **자동 연결 상태 업데이트**: 오류 발생 시 `is_connected` 플래그 자동 업데이트

### 8. 타임아웃 및 폴링 제어 개선
- **적응적 sleep**: 출력 활동에 따른 동적 대기 시간 조정
  - 활발한 출력 중: 0.05초 sleep
  - 출력 대기 중: 0.1초 sleep
- **연속 빈 읽기 감지**: 30회 이상 빈 읽기 시 프롬프트 도달 확인
- **강제 종료 방지**: 50회 이상 빈 읽기 시 타임아웃 처리
- **타임아웃 증가**: 명령어 실행 타임아웃을 10초에서 15초로 증가

### 9. 결과 파싱 최적화
- **프롬프트 도달 확인**: 수신 완료 판단 기준으로 프롬프트 패턴 사용
- **빈 출력 처리**: None 반환으로 연결 문제 표시
- **인코딩 오류 허용**: 일부 문자 깨짐 허용하고 계속 진행

## 주요 개선 효과

1. **이상한 문자 제거**: ANSI 코드와 제어문자 완전 정리
2. **--More-- 자동 처리**: 페이지 출력 자동 진행으로 멈춤 방지
3. **안정적인 프롬프트 감지**: 다양한 프롬프트 패턴 지원
4. **향상된 오류 처리**: 연결 문제 조기 감지 및 복구
5. **최적화된 타이밍**: 적응적 폴링으로 성능과 안정성 균형
6. **깔끔한 출력**: 명령어 에코, 프롬프트, 제어문자 완전 제거

이러한 개선으로 SSH를 통한 Palo Alto 장비 명령어 실행이 훨씬 안정적이고 깔끔한 결과를 제공하게 되었습니다.